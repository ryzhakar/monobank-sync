---
name: CI/CD

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1
    SQLX_OFFLINE: true

jobs:
  # Test with PostgreSQL (default)
    test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy, rustfmt

            - name: Cache dependencies
              uses: Swatinem/rust-cache@v2

            - name: Check formatting
              run: cargo fmt --all -- --check

            - name: Clippy
              run: cargo clippy -- -D warnings

            - name: Build
              run: cargo build

            - name: Run tests
              run: cargo test

  # Build release
    build-release:
        runs-on: ubuntu-latest
        needs: [test]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Cache dependencies
              uses: Swatinem/rust-cache@v2

            - name: Build release
              run: cargo build --release

  # Publish to crates.io
    publish:
        runs-on: ubuntu-latest
        needs: build-release
        if: github.ref == 'refs/heads/main' && github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip publish]')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Cache dependencies
              uses: Swatinem/rust-cache@v2

            - name: Build for publishing
              run: cargo build --release

            - name: Publish to crates.io
              run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }}
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
